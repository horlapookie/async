// ğŸ”® Plugin created by DevAfeez
// âš™ï¸ Rebranded and enhanced by TruvaGPT
// ğŸ“¢ Do not remove credits or redistribute without permission.

const axios = require('axios');

async function apiMakerCommand(sock, chatId, message) {
    try {
        const text = message.message?.conversation || message.message?.extendedTextMessage?.text || '';
        const body = text.trim();
        const triggers = ['/api', '/apimaker', '/createapi'];
        const usedTrigger = triggers.find(cmd => body.startsWith(cmd));

        if (!usedTrigger) return;

        const query = body.replace(usedTrigger, '').trim();

        if (!query) {
            const helpMessage = `â•”â•â•â• âœ¦ *ğŸ”§ API Maker by TruvaGPT* âœ¦ â•â•â•â•—
ğŸ¤– Create and test custom API endpoints easily
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”‚
â”œâ—† ğŸ’¡ *Usage:* \`/api <METHOD> <ENDPOINT> <RESPONSE_TYPE>\`
â”‚
â”œâ—† ğŸ“Œ *Examples:*
â”œâ—† /api GET /users json
â”œâ—† /api POST /create-user text
â”œâ—† /api PUT /update-product xml
â”‚
â”œâ—† âš™ï¸ *Parameters:*
â”œâ—† â€¢ METHOD â†’ GET | POST | PUT | DELETE
â”œâ—† â€¢ ENDPOINT â†’ Must start with '/'
â”œâ—† â€¢ RESPONSE â†’ json | text | xml
â”‚
â””â”€â”€â”€ ğŸ’« *Powered by TruvaGPT*`;

            return await sock.sendMessage(chatId, { text: helpMessage });
        }

        const parts = query.split(/\s+/);
        if (parts.length < 3) {
            return await sock.sendMessage(chatId, { 
                text: `âŒ Invalid format!\n\nUse:\n\`/api <METHOD> <ENDPOINT> <RESPONSE_TYPE>\``
            });
        }

        const [method, endpoint, responseType] = parts;
        const validMethods = ['GET', 'POST', 'PUT', 'DELETE'];
        const validResponseTypes = ['json', 'text', 'xml'];

        if (!validMethods.includes(method.toUpperCase())) {
            return await sock.sendMessage(chatId, { 
                text: `ğŸš« Invalid method!\nUse one of: ${validMethods.join(', ')}`
            });
        }

        if (!endpoint.startsWith('/')) {
            return await sock.sendMessage(chatId, { 
                text: `âš ï¸ Endpoint must start with '/'\nExample: \`/api GET /users json\``
            });
        }

        if (!validResponseTypes.includes(responseType.toLowerCase())) {
            return await sock.sendMessage(chatId, { 
                text: `âŒ Invalid response type!\nChoose: ${validResponseTypes.join(', ')}`
            });
        }

        // React while generating API
        await sock.sendMessage(chatId, { react: { text: 'âš™ï¸', key: message.key } });

        const apiStructure = {
            method: method.toUpperCase(),
            endpoint: endpoint,
            responseType: responseType.toLowerCase(),
            createdAt: new Date().toISOString(),
            status: "draft"
        };

        const responseTemplates = {
            json: { status: true, message: "API endpoint created successfully", data: {} },
            text: "API endpoint created successfully âœ…",
            xml: `<?xml version="1.0" encoding="UTF-8"?><api><status>true</status><message>API endpoint created successfully</message></api>`
        };

        const responseTemplate = responseTemplates[responseType.toLowerCase()];

        const apiCode = `
// ${apiStructure.method} ${apiStructure.endpoint}
app.${apiStructure.method.toLowerCase()}('${apiStructure.endpoint}', (req, res) => {
    try {
        // Your API logic here
        res.${apiStructure.responseType}(${JSON.stringify(responseTemplate, null, 2)});
    } catch (error) {
        res.status(500).json({ status: false, message: error.message });
    }
});
`;

        const apiDetails = `â•”â•â•â• âœ¦ *ğŸŒ API Endpoint Created!* âœ¦ â•â•â•â•—
ğŸ¤– Generated by TruvaGPT
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”‚
â”œâ—† ğŸ“ Method: *${apiStructure.method}*
â”œâ—† ğŸ”— Endpoint: *${apiStructure.endpoint}*
â”œâ—† ğŸ’¾ Response Type: *${apiStructure.responseType}*
â”œâ—† â° Created: *${new Date(apiStructure.createdAt).toLocaleString()}*
â”‚
â”œâ—† ğŸ§© *Implementation Example:*
\`\`\`javascript
${apiCode}
\`\`\`
â”‚
â”œâ—† ğŸ“¦ *Sample Response:*
\`\`\`${apiStructure.responseType}
${JSON.stringify(responseTemplate, null, 2)}
\`\`\`
â”‚
â””â”€â”€â”€ âœ¨ *TruvaGPT API Maker Complete!*`;

        await sock.sendMessage(chatId, {
            text: apiDetails,
            contextInfo: {
                forwardingScore: 1,
                isForwarded: false,
                forwardedNewsletterMessageInfo: {
                    newsletterJid: '120363401657714060@newsletter',
                    newsletterName: 'TruvaGPT',
                    serverMessageId: -1
                }
            }
        });

        await sock.sendMessage(chatId, { react: { text: 'âœ…', key: message.key } });

    } catch (error) {
        console.error('API Maker Error:', error);
        await sock.sendMessage(chatId, {
            text: `âŒ *API Creation Failed!*\n\nError: ${error.message}`
        });
    }
}

module.exports = apiMakerCommand;